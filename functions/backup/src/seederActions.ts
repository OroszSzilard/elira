import { onCall, HttpsError } from 'firebase-functions/v2/https';
import * as admin from 'firebase-admin';
import { z } from 'zod';
import { FieldValue } from 'firebase-admin/firestore';

// Input validation schema
const seedDatabaseSchema = z.object({
  force: z.boolean().optional().default(false)
});

export const seedDatabase = onCall(async (request) => {
  try {
    // Check if user is authenticated
    if (!request.auth) {
      throw new HttpsError('unauthenticated', 'Felhaszn√°l√≥nak be kell jelentkeznie');
    }

    // Check if user has ADMIN role
    const userDoc = await admin.firestore().collection('users').doc(request.auth.uid).get();
    if (!userDoc.exists) {
      throw new HttpsError('permission-denied', 'Felhaszn√°l√≥ nem tal√°lhat√≥');
    }

    const userData = userDoc.data();
    if (userData?.role !== 'ADMIN') {
      throw new HttpsError('permission-denied', 'Csak admin felhaszn√°l√≥k futtathatj√°k ezt a funkci√≥t');
    }

    // Validate input
    const { force } = seedDatabaseSchema.parse(request.data);

    console.log('üå± Starting database seeding...');

    // Clear existing data if force is true
    if (force) {
      console.log('üóëÔ∏è Clearing existing data...');
      await clearExistingData();
    }

    // Define test data
    const categories = [
      {
        name: 'Webfejleszt√©s',
        description: 'Modern webalkalmaz√°sok fejleszt√©se √©s karbantart√°sa',
        slug: 'webfejlesztes',
        icon: 'code',
        color: '#3B82F6'
      },
      {
        name: 'Digit√°lis Marketing',
        description: 'Online marketing strat√©gi√°k √©s eszk√∂z√∂k',
        slug: 'digitalis-marketing',
        icon: 'trending-up',
        color: '#10B981'
      },
      {
        name: 'AI √©s G√©pi Tanul√°s',
        description: 'Mesters√©ges intelligencia √©s g√©pi tanul√°s alapjai',
        slug: 'ai-gepi-tanulas',
        icon: 'brain',
        color: '#8B5CF6'
      },
      {
        name: 'Adatelemz√©s',
        description: 'Adatok elemz√©se √©s vizualiz√°l√°sa',
        slug: 'adatelemzes',
        icon: 'bar-chart',
        color: '#F59E0B'
      },
      {
        name: 'Grafikai Tervez√©s',
        description: 'Digit√°lis grafikai tervez√©s √©s UX/UI design',
        slug: 'grafikai-tervezes',
        icon: 'palette',
        color: '#EF4444'
      }
    ];

    const universities = [
      {
        name: 'Budapesti M≈±szaki √©s Gazdas√°gtudom√°nyi Egyetem',
        slug: 'bme',
        description: 'Magyarorsz√°g legnagyobb m≈±szaki egyeteme',
        logo: null,
        website: 'https://www.bme.hu',
        location: 'Budapest'
      },
      {
        name: 'E√∂tv√∂s Lor√°nd Tudom√°nyegyetem',
        slug: 'elte',
        description: 'Magyarorsz√°g legr√©gebbi egyeteme',
        logo: null,
        website: 'https://www.elte.hu',
        location: 'Budapest'
      },
      {
        name: 'Szegedi Tudom√°nyegyetem',
        slug: 'szte',
        description: 'D√©l-Magyarorsz√°g vezet≈ë egyeteme',
        logo: null,
        website: 'https://www.u-szeged.hu',
        location: 'Szeged'
      }
    ];

    const courses = [
      {
        title: 'React.js Alapok',
        description: 'Tanuld meg a modern webalkalmaz√°sok fejleszt√©s√©t React.js-szel',
        categoryId: 'webfejlesztes',
        universityId: 'bme',
        instructorId: request.auth.uid,
        price: 29900,
        status: 'published',
        difficulty: 'beginner',
        language: 'hu',
        certificateEnabled: true,
        enrollmentCount: 0,
        ratingCount: 0,
        averageRating: 0,
        modules: [
          {
            title: 'React Bevezet√©s',
            order: 1,
            lessons: [
              {
                title: 'Mi az a React?',
                order: 1,
                duration: 15,
                type: 'video'
              },
              {
                title: 'Els≈ë React Komponens',
                order: 2,
                duration: 25,
                type: 'video'
              }
            ]
          }
        ]
      },
      {
        title: 'Digit√°lis Marketing Strat√©gi√°k',
        description: 'Hat√©kony online marketing kamp√°nyok tervez√©se √©s v√©grehajt√°sa',
        categoryId: 'digitalis-marketing',
        universityId: 'elte',
        instructorId: request.auth.uid,
        price: 39900,
        status: 'published',
        difficulty: 'intermediate',
        language: 'hu',
        certificateEnabled: true,
        enrollmentCount: 0,
        ratingCount: 0,
        averageRating: 0,
        modules: [
          {
            title: 'Marketing Alapok',
            order: 1,
            lessons: [
              {
                title: 'Digit√°lis Marketing Bevezet√©s',
                order: 1,
                duration: 20,
                type: 'video'
              },
              {
                title: 'C√©lk√∂z√∂ns√©g Elemz√©s',
                order: 2,
                duration: 30,
                type: 'video'
              }
            ]
          }
        ]
      },
      {
        title: 'Python G√©pi Tanul√°s',
        description: 'G√©pi tanul√°si algoritmusok implement√°l√°sa Python-ban',
        categoryId: 'ai-gepi-tanulas',
        universityId: 'szte',
        instructorId: request.auth.uid,
        price: 49900,
        status: 'published',
        difficulty: 'advanced',
        language: 'hu',
        certificateEnabled: true,
        enrollmentCount: 0,
        ratingCount: 0,
        averageRating: 0,
        modules: [
          {
            title: 'G√©pi Tanul√°s Alapok',
            order: 1,
            lessons: [
              {
                title: 'Mi az a G√©pi Tanul√°s?',
                order: 1,
                duration: 25,
                type: 'video'
              },
              {
                title: 'Python √©s NumPy',
                order: 2,
                duration: 35,
                type: 'video'
              }
            ]
          }
        ]
      },
      {
        title: 'Excel Adatelemz√©s',
        description: 'Professzion√°lis adatelemz√©s Excel-ben √©s Power BI-ban',
        categoryId: 'adatelemzes',
        universityId: 'bme',
        instructorId: request.auth.uid,
        price: 19900,
        status: 'published',
        difficulty: 'beginner',
        language: 'hu',
        certificateEnabled: true,
        enrollmentCount: 0,
        ratingCount: 0,
        averageRating: 0,
        modules: [
          {
            title: 'Excel Alapok',
            order: 1,
            lessons: [
              {
                title: 'Excel Kezd≈ë L√©p√©sek',
                order: 1,
                duration: 20,
                type: 'video'
              },
              {
                title: 'Adatok Form√°z√°sa',
                order: 2,
                duration: 25,
                type: 'video'
              }
            ]
          }
        ]
      },
      {
        title: 'Figma UI/UX Design',
        description: 'Modern felhaszn√°l√≥i fel√ºletek tervez√©se Figma-ban',
        categoryId: 'grafikai-tervezes',
        universityId: 'elte',
        instructorId: request.auth.uid,
        price: 34900,
        status: 'published',
        difficulty: 'intermediate',
        language: 'hu',
        certificateEnabled: true,
        enrollmentCount: 0,
        ratingCount: 0,
        averageRating: 0,
        modules: [
          {
            title: 'Figma Bevezet√©s',
            order: 1,
            lessons: [
              {
                title: 'Figma Alapok',
                order: 1,
                duration: 30,
                type: 'video'
              },
              {
                title: 'Komponensek L√©trehoz√°sa',
                order: 2,
                duration: 40,
                type: 'video'
              }
            ]
          }
        ]
      }
    ];

    // Insert categories
    console.log('üìÇ Inserting categories...');
    const categoryRefs = await insertCategories(categories);

    // Insert universities
    console.log('üèõÔ∏è Inserting universities...');
    const universityRefs = await insertUniversities(universities);

    // Insert courses with proper references
    console.log('üìö Inserting courses...');
    await insertCourses(courses, categoryRefs, universityRefs);

    console.log('‚úÖ Database seeding completed successfully!');
    console.log(`üìä Inserted: ${categories.length} categories, ${universities.length} universities, ${courses.length} courses`);

    return {
      success: true,
      message: 'Adatb√°zis sikeresen felt√∂ltve',
      stats: {
        categories: categories.length,
        universities: universities.length,
        courses: courses.length
      }
    };

  } catch (error) {
    console.error('‚ùå Error in seedDatabase:', error);
    throw new HttpsError('internal', 'Hiba t√∂rt√©nt az adatb√°zis felt√∂lt√©se sor√°n');
  }
});

export const seedDatabaseDev = onCall(async (request) => {
  try {
    console.log('üå± Starting development database seeding...');

    // Define test data
    const categories = [
      {
        name: 'Webfejleszt√©s',
        description: 'Modern webalkalmaz√°sok fejleszt√©se √©s karbantart√°sa',
        slug: 'webfejlesztes',
        icon: 'code',
        color: '#3B82F6'
      },
      {
        name: 'Digit√°lis Marketing',
        description: 'Online marketing strat√©gi√°k √©s eszk√∂z√∂k',
        slug: 'digitalis-marketing',
        icon: 'trending-up',
        color: '#10B981'
      },
      {
        name: 'AI √©s G√©pi Tanul√°s',
        description: 'Mesters√©ges intelligencia √©s g√©pi tanul√°s alapjai',
        slug: 'ai-gepi-tanulas',
        icon: 'brain',
        color: '#8B5CF6'
      },
      {
        name: 'Adatelemz√©s',
        description: 'Adatok elemz√©se √©s vizualiz√°l√°sa',
        slug: 'adatelemzes',
        icon: 'bar-chart',
        color: '#F59E0B'
      },
      {
        name: 'Grafikai Tervez√©s',
        description: 'Digit√°lis grafikai tervez√©s √©s UX/UI design',
        slug: 'grafikai-tervezes',
        icon: 'palette',
        color: '#EF4444'
      }
    ];

    const universities = [
      {
        name: 'Budapesti M≈±szaki √©s Gazdas√°gtudom√°nyi Egyetem',
        slug: 'bme',
        description: 'Magyarorsz√°g legnagyobb m≈±szaki egyeteme',
        logoUrl: null,
        website: 'https://www.bme.hu',
        location: 'Budapest'
      },
      {
        name: 'E√∂tv√∂s Lor√°nd Tudom√°nyegyetem',
        slug: 'elte',
        description: 'Magyarorsz√°g legr√©gebbi egyeteme',
        logoUrl: null,
        website: 'https://www.elte.hu',
        location: 'Budapest'
      },
      {
        name: 'Szegedi Tudom√°nyegyetem',
        slug: 'szte',
        description: 'D√©l-Magyarorsz√°g vezet≈ë egyeteme',
        logoUrl: null,
        website: 'https://www.u-szeged.hu',
        location: 'Szeged'
      }
    ];

    const courses = [
      {
        title: 'React √©s Next.js Alapok',
        description: 'Modern webalkalmaz√°sok fejleszt√©se React √©s Next.js seg√≠ts√©g√©vel',
        slug: 'react-nextjs-alapok',
        categoryId: 'webfejlesztes',
        universityId: 'bme',
        instructorId: 'dev-instructor',
        language: 'hu',
        difficulty: 'BEGINNER',
        status: 'PUBLISHED',
        isPlus: false,
        priceHUF: 0,
        certificateEnabled: true,
        thumbnailUrl: '/images/course-placeholder.png',
        metaDescription: 'Tanulja meg a React √©s Next.js alapjait',
        keywords: ['react', 'nextjs', 'web', 'fejleszt√©s'],
        visibility: 'PUBLIC',
        enrollmentCount: 0,
        averageRating: 0,
        ratingCount: 0,
        moduleCount: 3,
        lessonCount: 12,
        totalDuration: 3600,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        publishedAt: new Date().toISOString()
      },
      {
        title: 'Digit√°lis Marketing Strat√©gi√°k',
        description: 'Hat√©kony online marketing kamp√°nyok tervez√©se √©s v√©grehajt√°sa',
        slug: 'digitalis-marketing-strategiak',
        categoryId: 'digitalis-marketing',
        universityId: 'elte',
        instructorId: 'marketing-instructor',
        language: 'hu',
        difficulty: 'INTERMEDIATE',
        status: 'PUBLISHED',
        isPlus: true,
        priceHUF: 25000,
        certificateEnabled: true,
        thumbnailUrl: '/images/course-placeholder.png',
        metaDescription: 'Digit√°lis marketing strat√©gi√°k √©s eszk√∂z√∂k',
        keywords: ['marketing', 'digit√°lis', 'online', 'kamp√°ny'],
        visibility: 'PUBLIC',
        enrollmentCount: 0,
        averageRating: 0,
        ratingCount: 0,
        moduleCount: 4,
        lessonCount: 16,
        totalDuration: 4800,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        publishedAt: new Date().toISOString()
      },
      {
        title: 'Python G√©pi Tanul√°s',
        description: 'G√©pi tanul√°si algoritmusok implement√°l√°sa Python-ban',
        slug: 'python-gepi-tanulas',
        categoryId: 'ai-gepi-tanulas',
        universityId: 'szte',
        instructorId: 'ai-instructor',
        language: 'hu',
        difficulty: 'ADVANCED',
        status: 'PUBLISHED',
        isPlus: true,
        priceHUF: 35000,
        certificateEnabled: true,
        thumbnailUrl: '/images/course-placeholder.png',
        metaDescription: 'G√©pi tanul√°s Python programoz√°si nyelvben',
        keywords: ['python', 'g√©pi tanul√°s', 'ai', 'algoritmus'],
        visibility: 'PUBLIC',
        enrollmentCount: 0,
        averageRating: 0,
        ratingCount: 0,
        moduleCount: 5,
        lessonCount: 20,
        totalDuration: 6000,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        publishedAt: new Date().toISOString()
      }
    ];

    // Insert data
    const categoryRefs = await insertCategories(categories);
    const universityRefs = await insertUniversities(universities);

    // Insert initial courses and capture references
    const courseRefs = await insertCourses(courses, categoryRefs, universityRefs);

    // ----- OBJECTIVES --------------------------------------------------
    const objectives = [
      { name: 'Karrierv√°lt√°s', description: '√öj karriert kezdeni a tech szektorban', slug: 'karriervaltas', icon: 'briefcase', color: '#3B82F6' },
      { name: 'K√©szs√©gfejleszt√©s', description: 'Megl√©v≈ë k√©szs√©gek b≈ëv√≠t√©se √©s fejleszt√©se', slug: 'keszsegfejlesztes', icon: 'trending-up', color: '#10B981' },
      { name: 'Egyetemi Felk√©sz√ºl√©s', description: 'Egyetemi tanulm√°nyokra val√≥ felk√©sz√ºl√©s', slug: 'egyetemi-felkeszules', icon: 'graduation-cap', color: '#8B5CF6' },
      { name: 'V√°llalati K√©pz√©s', description: 'Munkahelyi tov√°bbk√©pz√©s √©s fejl≈ëd√©s', slug: 'vallalati-kepzes', icon: 'building', color: '#F59E0B' },
    ];

    // ----- SAMPLE USERS -----------------------------------------------
    const sampleUsers = [
      { id: 'student-1', email: 'anna.kovacs@example.com', firstName: 'Anna', lastName: 'Kov√°cs', role: 'STUDENT', institution: 'BME', companyRole: null, createdAt: new Date('2024-01-15').toISOString(), updatedAt: new Date('2024-01-15').toISOString() },
      { id: 'student-2', email: 'peter.nagy@example.com', firstName: 'P√©ter', lastName: 'Nagy', role: 'STUDENT', institution: 'ELTE', companyRole: 'Junior Developer', createdAt: new Date('2024-02-10').toISOString(), updatedAt: new Date('2024-02-10').toISOString() },
      { id: 'student-3', email: 'eszter.toth@example.com', firstName: 'Eszter', lastName: 'T√≥th', role: 'STUDENT', institution: 'SZTE', companyRole: null, createdAt: new Date('2024-03-05').toISOString(), updatedAt: new Date('2024-03-05').toISOString() },
      { id: 'student-4', email: 'gabor.szabo@example.com', firstName: 'G√°bor', lastName: 'Szab√≥', role: 'STUDENT', institution: null, companyRole: 'Marketing Manager', createdAt: new Date('2024-02-20').toISOString(), updatedAt: new Date('2024-02-20').toISOString() },
    ];

    // ----- ADDITIONAL PUBLISHED COURSES -------------------------------
    const additionalCourses = [
      { title: 'Digit√°lis Marketing Strat√©gia', description: 'Hat√©kony online marketing kamp√°nyok tervez√©se √©s megval√≥s√≠t√°sa', slug: 'digitalis-marketing-strategia', categoryId: 'digitalis-marketing', universityId: 'elte', instructorId: 'marketing-instructor', language: 'hu', difficulty: 'INTERMEDIATE', status: 'PUBLISHED', isPlus: false, priceHUF: 29900, certificateEnabled: true, thumbnailUrl: '/images/course-placeholder.png', metaDescription: 'Professzion√°lis digit√°lis marketing strat√©gi√°k', keywords: ['marketing', 'digital', 'social media', 'SEO'], tags: ['marketing', 'SEO', 'social-media'], estimatedDuration: 480, createdAt: new Date('2024-01-10').toISOString(), updatedAt: new Date('2024-01-10').toISOString() },
      { title: 'Python Adatelemz√©s', description: 'Adatok elemz√©se √©s vizualiz√°l√°sa Python seg√≠ts√©g√©vel', slug: 'python-adatelemzes', categoryId: 'adatelemzes', universityId: 'szte', instructorId: 'data-instructor', language: 'hu', difficulty: 'INTERMEDIATE', status: 'PUBLISHED', isPlus: true, priceHUF: 39900, certificateEnabled: true, thumbnailUrl: '/images/course-placeholder.png', metaDescription: 'Python programoz√°s adatelemz√©shez', keywords: ['python', 'data', 'analytics', 'pandas'], tags: ['python', 'data-science', 'analytics'], estimatedDuration: 600, createdAt: new Date('2024-02-15').toISOString(), updatedAt: new Date('2024-02-15').toISOString() },
      { title: 'UI/UX Design Alapok', description: 'Felhaszn√°l√≥i √©lm√©ny √©s interf√©sz tervez√©s alapjai', slug: 'ui-ux-design-alapok', categoryId: 'grafikai-tervezes', universityId: 'bme', instructorId: 'design-instructor', language: 'hu', difficulty: 'BEGINNER', status: 'PUBLISHED', isPlus: false, priceHUF: 24900, certificateEnabled: true, thumbnailUrl: '/images/course-placeholder.png', metaDescription: 'Modern UI/UX tervez√©si m√≥dszerek', keywords: ['design', 'ui', 'ux', 'figma'], tags: ['design', 'ui', 'ux', 'figma'], estimatedDuration: 360, createdAt: new Date('2024-03-01').toISOString(), updatedAt: new Date('2024-03-01').toISOString() },
    ];

    // Insert additional courses and merge refs
    const additionalCourseRefs = await insertCourses(additionalCourses, categoryRefs, universityRefs);
    const allCourseRefs = { ...courseRefs, ...additionalCourseRefs };

    // ----- REVIEWS ----------------------------------------------------
    const reviews = [
      { userId: 'student-1', courseId: 'react-nextjs-alapok', rating: 5, comment: 'Fantasztikus kurzus! Nagyon j√≥l fel√©p√≠tett, k√∂nnyen k√∂vethet≈ë. A gyakorlati p√©ld√°k seg√≠tettek meg√©rteni a React alapjait.', isApproved: true, createdAt: new Date('2024-01-20').toISOString(), updatedAt: new Date('2024-01-20').toISOString() },
      { userId: 'student-2', courseId: 'digitalis-marketing-strategia', rating: 5, comment: 'Kiv√°l√≥ marketing kurzus! Sok gyakorlati tippet kaptam, amit r√∂gt√∂n alkalmaztam a munk√°mban. Mindenkinek aj√°nlom!', isApproved: true, createdAt: new Date('2024-02-25').toISOString(), updatedAt: new Date('2024-02-25').toISOString() },
      { userId: 'student-3', courseId: 'python-adatelemzes', rating: 4, comment: 'Nagyon hasznos kurzus volt. A Python basics-t≈ël indult, de hamar eljutottunk a komolyabb adatelemz√©si technik√°kig.', isApproved: true, createdAt: new Date('2024-03-10').toISOString(), updatedAt: new Date('2024-03-10').toISOString() },
      { userId: 'student-4', courseId: 'ui-ux-design-alapok', rating: 5, comment: 'T√∂k√©letes bevezet≈ë kurzus! M√©g sosem foglalkoztam tervez√©ssel, de ez a kurzus vil√°goss√° tette az alapokat.', isApproved: true, createdAt: new Date('2024-03-15').toISOString(), updatedAt: new Date('2024-03-15').toISOString() },
      { userId: 'student-1', courseId: 'digitalis-marketing-strategia', rating: 4, comment: 'J√≥ kurzus, sok hasznos inform√°ci√≥val. K√ºl√∂n√∂sen a social media marketing r√©sz tetszett.', isApproved: true, createdAt: new Date('2024-03-20').toISOString(), updatedAt: new Date('2024-03-20').toISOString() },
    ];

    // ----- ENROLLMENTS -----------------------------------------------
    const enrollments = [
      { id: 'student-1_react-nextjs-alapok', userId: 'student-1', courseId: 'react-nextjs-alapok', enrolledAt: new Date('2024-01-16').toISOString(), status: 'ACTIVE', progress: 75, completedAt: null },
      { id: 'student-2_digitalis-marketing-strategia', userId: 'student-2', courseId: 'digitalis-marketing-strategia', enrolledAt: new Date('2024-02-12').toISOString(), status: 'COMPLETED', progress: 100, completedAt: new Date('2024-02-24').toISOString() },
      { id: 'student-3_python-adatelemzes', userId: 'student-3', courseId: 'python-adatelemzes', enrolledAt: new Date('2024-03-06').toISOString(), status: 'ACTIVE', progress: 60, completedAt: null },
      { id: 'student-4_ui-ux-design-alapok', userId: 'student-4', courseId: 'ui-ux-design-alapok', enrolledAt: new Date('2024-03-02').toISOString(), status: 'COMPLETED', progress: 100, completedAt: new Date('2024-03-14').toISOString() },
    ];

    // Insert new collections
    await insertObjectives(objectives);
    await insertUsers(sampleUsers);
    await insertReviews(reviews, allCourseRefs);
    await insertEnrollments(enrollments, allCourseRefs);

    console.log('‚úÖ Development seeding completed successfully!');

    return {
      success: true,
      message: 'Development adatok sikeresen felt√∂ltve',
      stats: {
        categories: categories.length,
        universities: universities.length,
        courses: courses.length + additionalCourses.length,
        objectives: objectives.length,
        users: sampleUsers.length,
        reviews: reviews.length,
        enrollments: enrollments.length,
      }
    };

  } catch (error: any) {
    console.error('‚ùå Development seeding error:', error);
    return {
      success: false,
      error: error.message || 'Ismeretlen hiba t√∂rt√©nt'
    };
  }
});

async function clearExistingData() {
  const batch = admin.firestore().batch();
  
  // Clear categories
  const categoriesSnapshot = await admin.firestore().collection('categories').get();
  categoriesSnapshot.docs.forEach(doc => {
    batch.delete(doc.ref);
  });

  // Clear universities
  const universitiesSnapshot = await admin.firestore().collection('universities').get();
  universitiesSnapshot.docs.forEach(doc => {
    batch.delete(doc.ref);
  });

  // Clear courses
  const coursesSnapshot = await admin.firestore().collection('courses').get();
  coursesSnapshot.docs.forEach(doc => {
    batch.delete(doc.ref);
  });

  await batch.commit();
}

async function insertCategories(categories: any[]) {
  const batch = admin.firestore().batch();
  const refs: { [key: string]: any } = {};

  categories.forEach(category => {
    const ref = admin.firestore().collection('categories').doc();
    batch.set(ref, {
      ...category,
      createdAt: new Date(),
      updatedAt: new Date()
    });
    refs[category.slug] = ref;
  });

  await batch.commit();
  return refs;
}

async function insertUniversities(universities: any[]) {
  const batch = admin.firestore().batch();
  const refs: { [key: string]: any } = {};

  universities.forEach(university => {
    const ref = admin.firestore().collection('universities').doc();
    batch.set(ref, {
      ...university,
      createdAt: new Date(),
      updatedAt: new Date()
    });
    refs[university.slug] = ref;
  });

  await batch.commit();
  return refs;
}

async function insertCourses(courses: any[], categoryRefs: any, universityRefs: any) {
  const batch = admin.firestore().batch();
  const refs: { [key: string]: any } = {};

  for (const course of courses) {
    const courseRef = admin.firestore().collection('courses').doc();
    
    // Get the actual document references
    const categoryRef = categoryRefs[course.categoryId];
    const universityRef = universityRefs[course.universityId];
    
    if (!categoryRef || !universityRef) {
      console.warn(`‚ö†Ô∏è Missing reference for course ${course.title}: categoryId=${course.categoryId}, universityId=${course.universityId}`);
      continue;
    }

    // Insert course
    batch.set(courseRef, {
      title: course.title,
      description: course.description,
      slug: course.slug,
      categoryId: categoryRef.id,
      universityId: universityRef.id,
      instructorId: course.instructorId ?? 'system',

      // Pricing / visibility
      priceHUF: course.priceHUF ?? 0,
      isPlus: course.isPlus ?? false,
      status: course.status ?? 'PUBLISHED',
      difficulty: course.difficulty ?? 'BEGINNER',
      language: course.language ?? 'hu',
      certificateEnabled: course.certificateEnabled ?? true,

      // Counters ‚Äì default to 0 to satisfy Firestore validation
      enrollmentCount: course.enrollmentCount ?? 0,
      ratingCount: course.ratingCount ?? 0,
      averageRating: course.averageRating ?? 0,
      moduleCount: course.moduleCount ?? 0,
      lessonCount: course.lessonCount ?? 0,
      totalDuration: course.totalDuration ?? 0,

      thumbnailUrl: course.thumbnailUrl ?? null,
      metaDescription: course.metaDescription ?? '',
      keywords: course.keywords ?? [],
      tags: course.tags ?? [],
      visibility: course.visibility ?? 'PUBLIC',

      createdAt: new Date(),
      updatedAt: new Date(),
      publishedAt: new Date(),
    });
    refs[course.slug] = courseRef; // Store the reference by slug

    // Create modules and lessons subcollections (generate defaults if none provided)
    let modulesToInsert = Array.isArray(course.modules) && course.modules.length > 0
      ? course.modules
      : [
          {
            title: 'Bevezet≈ë modul',
            order: 1,
            lessons: [
              { title: 'Bevezet≈ë lecke', order: 1, duration: 10, type: 'video' },
              { title: 'Els≈ë gyakorlati lecke', order: 2, duration: 20, type: 'video' },
            ],
          },
        ];

    modulesToInsert.forEach((mod: any, mIndex: number) => {
        const moduleId = `module-${mIndex + 1}`;
        const moduleRef = courseRef.collection('modules').doc(moduleId);
        batch.set(moduleRef, {
          title: mod.title,
          order: mod.order ?? mIndex + 1,
          createdAt: new Date(),
          updatedAt: new Date(),
        });

        if (Array.isArray(mod.lessons)) {
          mod.lessons.forEach((les: any, lIndex: number) => {
            const lessonId = `lesson-${lIndex + 1}`;
            const lessonRef = moduleRef.collection('lessons').doc(lessonId);
            batch.set(lessonRef, {
              title: les.title,
              order: les.order ?? lIndex + 1,
              duration: les.duration ?? 0,
              type: les.type ?? 'video',
              createdAt: new Date(),
              updatedAt: new Date(),
            });

            // Also create a root-level lessons document for lookup functions
            const globalLessonRef = admin.firestore().collection('lessons').doc(lessonId);
            batch.set(globalLessonRef, {
              title: les.title,
              order: les.order ?? lIndex + 1,
              duration: les.duration ?? 0,
              type: les.type ?? 'video',
              courseId: courseRef.id,
              moduleId: moduleId,
              createdAt: new Date(),
              updatedAt: new Date(),
            });
          });
        }
      });

    admin.firestore().collection('categories').doc(categoryRef.id)
      .update({ courseCount: FieldValue.increment(1) });
  }

  await batch.commit();
  return refs;
} 

async function insertObjectives(objectives: any[]) {
  const batch = admin.firestore().batch();
  objectives.forEach(obj => {
    const ref = admin.firestore().collection('objectives').doc();
    batch.set(ref, {
      ...obj,
      createdAt: new Date(),
      updatedAt: new Date(),
    });
  });
  await batch.commit();
}

async function insertUsers(users: any[]) {
  const batch = admin.firestore().batch();
  users.forEach(user => {
    const ref = admin.firestore().collection('users').doc(user.id);
    batch.set(ref, user);
  });
  await batch.commit();
}

async function insertReviews(reviews: any[], courseRefs: any) {
  const batch = admin.firestore().batch();
  reviews.forEach(review => {
    const courseRef = courseRefs[review.courseId];
    if (courseRef) {
      const ref = admin.firestore().collection('reviews').doc();
      batch.set(ref, {
        ...review,
        courseId: courseRef.id,
      });
    }
  });
  await batch.commit();
}

async function insertEnrollments(enrollments: any[], courseRefs: any) {
  const batch = admin.firestore().batch();
  enrollments.forEach(enrollment => {
    const courseRef = courseRefs[enrollment.courseId];
    if (courseRef) {
      const ref = admin.firestore().collection('enrollments').doc(enrollment.id);
      batch.set(ref, {
        ...enrollment,
        courseId: courseRef.id,
      });
    }
  });
  await batch.commit();
} 